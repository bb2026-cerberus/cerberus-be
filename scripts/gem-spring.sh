#!/bin/bash

# ====================================================================================
# Gemini CLI Wrapper for Spring Boot 3.x Boilerplate Generator
# ====================================================================================

# ì‚¬ìš©ë²• ì•ˆë‚´
if [ "$#" -lt 2 ]; then
  echo "âŒ ì‚¬ìš©ë²•: $0 [create|read|update|delete|test|refactor] \"ìš”ì²­ ìƒì„¸ ë‚´ìš©\""
  echo "ì˜ˆì‹œ: $0 create \"íšŒì› ê°€ì… ê¸°ëŠ¥. ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë‹‰ë„¤ì„ ì…ë ¥. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” í•„ìš”.\""
  exit 1
fi

# ì¸ì íŒŒì‹±
ACTION=$1
USER_PROMPT=$2

# ------------------------------------------------------------------------------------
# [1] ì‹œìŠ¤í…œ í˜ë¥´ì†Œë‚˜ (SYSTEM / ROLE)
# ------------------------------------------------------------------------------------
read -r -d '' PROMPT_SYSTEM <<EOF
[System Instructions]
ë‹¹ì‹ ì€ 'Senior Java Backend Engineer'ì…ë‹ˆë‹¤.
Java 21, Spring Boot 3.x, JPA(Hibernate) í™˜ê²½ì—ì„œ í™•ì¥ ê°€ëŠ¥í•˜ê³  ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ìš´ 'Enterprise Grade Boilerplate' ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
ë‹¤ìŒì˜ [ê¸°ìˆ  ìŠ¤íƒ]ê³¼ [ê°œë°œ ì›ì¹™]ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì‹­ì‹œì˜¤.

[ì‘ë‹µ í’ˆì§ˆ ê°€ì´ë“œë¼ì¸]
1. ëª¨í˜¸í•œ ë‹µë³€ ëŒ€ì‹ , ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ì½”ë“œ(Copy-pasteable)ë¥¼ ì œê³µí•˜ì‹­ì‹œì˜¤.
2. ëª¨ë“  ì½”ë“œëŠ” Clean Code ì›ì¹™ê³¼ SOLID ì›ì¹™ì„ ë”°ë¥´ì‹­ì‹œì˜¤.
3. ì„¤ëª…ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ë˜, í•µì‹¬ ë¡œì§ê³¼ ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© ì´ìœ ë¥¼ ëª…í™•íˆ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
EOF

# ------------------------------------------------------------------------------------
# [2] ê¸°ìˆ  ìŠ¤íƒ ë° ì œì•½ ì¡°ê±´ (CONSTRAINTS)
# ------------------------------------------------------------------------------------
read -r -d '' PROMPT_ENV <<EOF
[ê°œë°œ í™˜ê²½ ë° ê¸°ìˆ  ìŠ¤íƒ]
1. ì–¸ì–´ & í”„ë ˆì„ì›Œí¬:
   - JDK 21 (Record, Switch Expressions, Var, Text Blocks ì ê·¹ í™œìš©)
   - Spring Boot 3.5.x (Jakarta EE 10 ê¸°ë°˜)
2. ë¹Œë“œ ë„êµ¬: Gradle (Groovy DSL)
3. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì œì•½:
   - Persistence: Spring Data JPA
   - Utils: Lombok (@Getter, @RequiredArgsConstructor ë“± ì ê·¹ í™œìš©)
   - Validation: Spring Boot Starter Validation (@Valid, @NotNull ë“±)
   - Doc: Springdoc OpenAPI (Swagger) ì–´ë…¸í…Œì´ì…˜ í¬í•¨ (@Operation, @Tag)
   - Test: JUnit 5, Mockito, AssertJ

[ì½”ë”© ì»¨ë²¤ì…˜ ë° ì•„í‚¤í…ì²˜ ê·œì¹™]
1. ê³„ì¸µ êµ¬ì¡°: Controller -> Service -> Repository êµ¬ì¡°ë¥¼ ì¤€ìˆ˜.
2. DTO ì‚¬ìš© ì›ì¹™:
   - Entityë¥¼ ì ˆëŒ€ë¡œ Controller ë°–ìœ¼ë¡œ ë…¸ì¶œí•˜ì§€ ë§ ê²ƒ.
   - Request/Response DTOëŠ” Java 21 'record' íƒ€ì…ì„ ìš°ì„  ê³ ë ¤í•˜ë˜, ì§ë ¬í™” ì´ìŠˆê°€ ì˜ˆìƒë˜ë©´ Class + Lombok(@Data) ì‚¬ìš©.
3. ì˜ì¡´ì„± ì£¼ì…: ìƒì„±ì ì£¼ì…(@RequiredArgsConstructor)ë§Œ ì‚¬ìš© (Field Injection ê¸ˆì§€).
4. íŒ¨í‚¤ì§€ êµ¬ì¡° ì˜ˆì‹œ: kr.co.boilerplate.demo.feature.{ë„ë©”ì¸ëª…}.{controller|service|dto|entity}
5. ì—ëŸ¬ ì²˜ë¦¬: GlobalExceptionHandlerë¥¼ í†µí•´ í‘œì¤€í™”ëœ ErrorResponse ë°˜í™˜.
6. Entity ê·œì¹™: Setter ì§€ì–‘ (ë³„ë„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ ì‚¬ìš©), ê¸°ë³¸ ìƒì„±ìëŠ” protected.
EOF

# ------------------------------------------------------------------------------------
# [3] ê²°ê³¼ë¬¼ í¬ë§· (OUTPUT FORMAT)
# ------------------------------------------------------------------------------------
read -r -d '' PROMPT_OUTPUT <<EOF
[ì¶œë ¥ í˜•ì‹]
1. íŒŒì¼ëª… ëª…ì‹œ: (ì˜ˆ: // src/main/java/.../MemberController.java)
2. ì „ì²´ ì½”ë“œ: import êµ¬ë¬¸ì„ í¬í•¨í•˜ì—¬ ìƒëµ ì—†ì´ ì‘ì„±.
3. ì£¼ìš” ì„¤ëª…: ì½”ë“œ ì‘ì„± ì˜ë„ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ í•µì‹¬ì„ ìš”ì•½.
4. í•„ìš” ì‹œ application.yml ì„¤ì •ì´ë‚˜ build.gradle ì˜ì¡´ì„± ì¶”ê°€ ë‚´ìš© í¬í•¨.
EOF

# ------------------------------------------------------------------------------------
# [4] ì•¡ì…˜ë³„ í…œí”Œë¦¿ (TEMPLATES)
# ------------------------------------------------------------------------------------

# CREATE: DTO -> Entity ë³€í™˜, ìœ íš¨ì„± ê²€ì‚¬, ì €ì¥
read -r -d '' ACTION_CREATE <<EOF
[ì‘ì—… ìœ í˜•: CREATE (ìƒì„±/ë“±ë¡)]
- ëª©í‘œ: ë°ì´í„°ë¥¼ ë°›ì•„ DBì— ì €ì¥í•˜ëŠ” API êµ¬í˜„.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. Request DTOì— Validation ì–´ë…¸í…Œì´ì…˜(@NotBlank, @Email ë“±) ì ìš©.
  2. Controllerì—ì„œ @Valid ì‚¬ìš©í•˜ì—¬ ê²€ì¦.
  3. Serviceì—ì„œ Entity ë³€í™˜(Mapper ë©”ì„œë“œ ë˜ëŠ” Builder íŒ¨í„´ ì‚¬ìš©) ë° Repository ì €ì¥.
  4. ì„±ê³µ ì‹œ 201 Created ìƒíƒœ ì½”ë“œì™€ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ì˜ ID ë˜ëŠ” URI ë°˜í™˜.
  5. ë¹„ë°€ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ëŠ” PasswordEncoderë¡œ ì•”í˜¸í™”.
EOF

# READ: ì¡°íšŒ, í˜ì´ì§•, ì˜ˆì™¸ ì²˜ë¦¬
read -r -d '' ACTION_READ <<EOF
[ì‘ì—… ìœ í˜•: READ (ì¡°íšŒ/ëª©ë¡)]
- ëª©í‘œ: ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ DTOë¡œ ë°˜í™˜í•˜ëŠ” API êµ¬í˜„.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. ë‹¨ê±´ ì¡°íšŒ: ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° ì»¤ìŠ¤í…€ ì˜ˆì™¸(ì˜ˆ: ResourceNotFoundException) ë°œìƒ.
  2. ëª©ë¡ ì¡°íšŒ: Pageable ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•œ í˜ì´ì§• ì²˜ë¦¬ ê¶Œì¥.
  3. ì¡°íšŒ ì „ìš© ë©”ì„œë“œì—ëŠ” @Transactional(readOnly = true) í•„ìˆ˜ ì ìš©.
  4. Response DTOë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ í•„ë“œë§Œ ë…¸ì¶œ.
EOF

# UPDATE: Dirty Checking, ë¶€ë¶„ ì—…ë°ì´íŠ¸
read -r -d '' ACTION_UPDATE <<EOF
[ì‘ì—… ìœ í˜•: UPDATE (ìˆ˜ì •)]
- ëª©í‘œ: ê¸°ì¡´ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. JPA Dirty Checking(ë³€ê²½ ê°ì§€) ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ update ì¿¼ë¦¬ ì—†ì´ ì²˜ë¦¬.
  2. Entity ë‚´ë¶€ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ì€ ìˆ˜ì • ë©”ì„œë“œ(ì˜ˆ: changeInfo()) ì‘ì„± (Setter ì‚¬ìš© ê¸ˆì§€).
  3. ìˆ˜ì • ê¶Œí•œ í™•ì¸ ë¡œì§(ì‘ì„±ì ë³¸ì¸ í™•ì¸ ë“±)ì´ í•„ìš”í•˜ë‹¤ë©´ Service ë ˆì´ì–´ì— í¬í•¨.
EOF

# DELETE: ì‚­ì œ (Soft/Hard)
read -r -d '' ACTION_DELETE <<EOF
[ì‘ì—… ìœ í˜•: DELETE (ì‚­ì œ)]
- ëª©í‘œ: ë°ì´í„° ì‚­ì œ API êµ¬í˜„.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. IDë¡œ Entity ì¡°íšŒ í›„ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì—†ìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ).
  2. Hard Delete(deleteById) ë˜ëŠ” Soft Delete(deletedAt í•„ë“œ ì—…ë°ì´íŠ¸) ë°©ì‹ ì¤‘ ìƒí™©ì— ë§ëŠ” ë°©ì‹ ì œì•ˆ.
  3. ì—°ê´€ ê´€ê³„ê°€ ìˆëŠ” ë°ì´í„° ì‚­ì œ ì‹œ ì²˜ë¦¬ ë°©ì•ˆ(Cascade ë“±) ê³ ë ¤.
EOF

# REFACTOR: ê¸°ì¡´ ì½”ë“œ ê°œì„ , ë²„ê·¸ ìˆ˜ì •, ì»¨ë²¤ì…˜ ì ìš©
read -r -d '' ACTION_REFACTOR <<EOF
[ì‘ì—… ìœ í˜•: REFACTOR (ì½”ë“œ ê°œì„  ë° ìˆ˜ì •)]
- ëª©í‘œ: ì‚¬ìš©ìê°€ ì œê³µí•œ ì½”ë“œë¥¼ í”„ë¡œì íŠ¸ ì»¨ë²¤ì…˜(Clean Architecture, SOLID)ì— ë§ê²Œ ìˆ˜ì •.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. ê¸°ëŠ¥(Business Logic)ì€ ìœ ì§€í•˜ë˜, ì½”ë“œ êµ¬ì¡°ì™€ ìŠ¤íƒ€ì¼ì„ ê°œì„ .
  2. DTOê°€ Classë¡œ ë˜ì–´ìˆë‹¤ë©´ Java 21 Recordë¡œ ë³€í™˜ ê³ ë ¤.
  3. Field Injection(@Autowired)ì´ ìˆë‹¤ë©´ ìƒì„±ì ì£¼ì…(@RequiredArgsConstructor)ìœ¼ë¡œ ë³€ê²½.
  4. ë¡œì§ì— ì ì¬ì  ë²„ê·¸(NullPointer ë“±)ê°€ ìˆë‹¤ë©´ ìˆ˜ì •í•˜ê³  ì£¼ì„ìœ¼ë¡œ ì„¤ëª….
  5. ë¶ˆí•„ìš”í•œ ì£¼ì„ì€ ì œê±°í•˜ê³ , í•µì‹¬ ë¡œì§ì—ë§Œ ì„¤ëª… ì¶”ê°€.
  6. ë§Œì•½ ì‚¬ìš©ìê°€ ì—ëŸ¬ ë¡œê·¸ë¥¼ ì œê³µí–ˆë‹¤ë©´, ì›ì¸ì„ ë¶„ì„í•˜ê³  í•´ê²°ì±… ì½”ë“œ ì œì‹œ.
EOF

# TEST: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (JUnit5 + Mockito)
read -r -d '' ACTION_TEST <<EOF
[ì‘ì—… ìœ í˜•: TEST (í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±)]
- ëª©í‘œ: ì‘ì„±ëœ ê¸°ëŠ¥ì— ëŒ€í•œ ê²€ì¦ ì½”ë“œ ì‘ì„±.
- í•„ìˆ˜ ìš”êµ¬ì‚¬í•­:
  1. Service ë ˆì´ì–´: @ExtendWith(MockitoExtension.class)ë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸.
  2. Repository ë ˆì´ì–´: @DataJpaTestë¥¼ ì‚¬ìš©í•œ ìŠ¬ë¼ì´ìŠ¤ í…ŒìŠ¤íŠ¸.
  3. Controller ë ˆì´ì–´: @WebMvcTestë¥¼ ì‚¬ìš©í•˜ê³  MockMvcë¡œ API í˜¸ì¶œ ê²€ì¦.
  4. BDD ìŠ¤íƒ€ì¼(given/when/then)ë¡œ ì£¼ì„ì„ ë‹¬ì•„ ê°€ë…ì„± í™•ë³´.
  5. AssertJì˜ assertThat()ì„ ì‚¬ìš©í•˜ì—¬ ê²€ì¦.
EOF

# ------------------------------------------------------------------------------------
# [5] í”„ë¡¬í”„íŠ¸ ì¡°ë¦½ ë° ì‹¤í–‰
# ------------------------------------------------------------------------------------

case "$ACTION" in
  create)   SELECTED_TEMPLATE="$ACTION_CREATE" ;;
  read)     SELECTED_TEMPLATE="$ACTION_READ" ;;
  update)   SELECTED_TEMPLATE="$ACTION_UPDATE" ;;
  delete)   SELECTED_TEMPLATE="$ACTION_DELETE" ;;
  test)     SELECTED_TEMPLATE="$ACTION_TEST" ;;
  refactor) SELECTED_TEMPLATE="$ACTION_REFACTOR" ;;
  *)
    echo "âŒ ì—ëŸ¬: create, read, update, delete, test, refactor ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
    exit 1
    ;;
esac

# ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±
FULL_PROMPT="$PROMPT_SYSTEM

$PROMPT_ENV

$PROMPT_OUTPUT

$SELECTED_TEMPLATE

[ì‚¬ìš©ì ìš”ì²­ ì‚¬í•­]
\"$USER_PROMPT\"

ìœ„ì˜ ì§€ì¹¨ì„ ë°”íƒ•ìœ¼ë¡œ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì™„ë²½í•œ Java ì½”ë“œë¥¼ ì‘ì„±í•´ì¤˜."

# ë””ë²„ê¹…ìš© (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
# echo "$FULL_PROMPT"

echo -e "ğŸš€ Spring Boot 3.x ì½”ë“œ ìƒì„± ìš”ì²­ ì¤‘... [Action: $ACTION]\n"

# Gemini CLI ì‹¤í–‰ (í™˜ê²½ì— ë§ê²Œ ëª…ë ¹ì–´ ìˆ˜ì • ê°€ëŠ¥)
gemini "$FULL_PROMPT"